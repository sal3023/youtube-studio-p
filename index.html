    async function callGemini(type) {
        const key = localStorage.getItem('gemini_api_key');
        if(!key) return alert("يرجى وضع مفتاح API في الإعدادات أولاً!");

        let prompt = "";
        let resDiv = "";

        if(type === 'blog') {
            const topic = document.getElementById('blogTopic').value;
            prompt = `اكتب مقالاً لمدونة تقنية tosh5.shop عن: ${topic}`;
            resDiv = document.getElementById('blog-res');
        } else if(type === 'script') {
            const topic = document.getElementById('scriptTopic').value;
            prompt = `اكتب سكربت فيديو عن: ${topic}`;
            resDiv = document.getElementById('script-res');
        } else {
            const topic = document.getElementById('seoTopic').value;
            prompt = `أعطني تاجات SEO لموضوع: ${topic}`;
            resDiv = document.getElementById('seo-res');
        }

        resDiv.innerHTML = '<span class="loading-pulse">⏳ جاري المعالجة...</span>';

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            
            // إذا وجد خطأ في الاستجابة
            if (data.error) {
                resDiv.innerHTML = `❌ خطأ من جوجل: ${data.error.message}`;
                console.error(data.error);
                return;
            }

            const resultText = data.candidates[0].content.parts[0].text;
            resDiv.innerText = resultText;
        } catch (error) {
            resDiv.innerHTML = `❌ فشل الاتصال: ${error.message}`;
        }
    }
