#!/usr/bin/env python3
"""
hd4kstudio - 4K Islamic Video Generator
"""

import os
import sys
import subprocess

def install_packages():
    packages = ['moviepy', 'Pillow', 'numpy', 'gTTS', 'pydub', 'requests', 'imageio']
    for pkg in packages:
        try:
            __import__(pkg.lower().replace('pillow', 'PIL'))
        except ImportError:
            subprocess.check_call([sys.executable, "-m", "pip", "install", pkg, "-q"])

install_packages()

import requests
from pathlib import Path
from datetime import datetime
from time import sleep
from moviepy.editor import *
from moviepy.video.fx.all import fadein, fadeout
from gtts import gTTS
from pydub import AudioSegment
from PIL import Image, ImageDraw

CONFIG = {'width': 3840, 'height': 2160, 'fps': 60, 'duration': 600, 'bitrate': '40000k'}

for folder in ['output', 'assets/images', 'assets/audio']:
    Path(folder).mkdir(parents=True, exist_ok=True)

class ImageScraper:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({'User-Agent': 'Mozilla/5.0'})
        self.output_dir = Path("assets/images")
    
    def download(self, query="islamic", count=10):
        print(f"Downloading {count} images...")
        images = []
        for i in range(count):
            try:
                url = f"https://source.unsplash.com/3840x2160/?{query.replace(' ', ',')}"
                response = self.session.get(url, timeout=30)
                if response.status_code == 200:
                    filepath = self.output_dir / f"img_{i:03d}.jpg"
                    with open(filepath, 'wb') as f:
                        f.write(response.content)
                    images.append(str(filepath))
                    print(f"  OK {i+1}/{count}")
                    sleep(0.3)
            except:
                print(f"  Skip {i+1}")
        return images if images else self.create_placeholders(count)
    
    def create_placeholders(self, count):
        images = []
        for i in range(count):
            img = Image.new('RGB', (3840, 2160), color=(20, 40, 60))
            draw = ImageDraw.Draw(img)
            draw.text((1500, 1000), f"Islamic {i+1}", fill=(255, 215, 0))
            filepath = self.output_dir / f"placeholder_{i:03d}.jpg"
            img.save(filepath)
            images.append(str(filepath))
        return images

class ArabicVoice:
    def __init__(self):
        self.output_dir = Path("assets/audio")
    
    def create(self, text, filename="voice.mp3"):
        try:
            filepath = self.output_dir / filename
            tts = gTTS(text=text, lang='ar', slow=False)
            tts.save(str(filepath))
            audio = AudioSegment.from_mp3(filepath)
            audio = audio.set_frame_rate(48000).set_channels(2)
            audio.export(filepath, format="mp3", bitrate="320k")
            return str(filepath)
        except:
            return None

class VideoBuilder:
    def __init__(self):
        self.w = CONFIG['width']
        self.h = CONFIG['height']
    
    def build(self, images, texts, audio_file, output_path):
        print("Building 4K video...")
        duration = CONFIG['duration']
        segment_duration = duration / len(texts)
        clips = []
        
        for i, (text, img_path) in enumerate(zip(texts, images[:len(texts)])):
            bg = (ImageClip(img_path).set_duration(segment_duration)
                  .resize(height=self.h).set_position('center'))
            overlay = ColorClip((self.w, self.h), (0,0,0)).set_duration(segment_duration).set_opacity(0.5)
            txt = (TextClip(text, fontsize=140, color='gold', font='Arial-Bold',
                          stroke_color='black', stroke_width=4, method='caption',
                          size=(3600, None), align='center')
                   .set_duration(segment_duration).set_position('center').fx(fadein, duration=1.5))
            segment = CompositeVideoClip([bg, overlay, txt], size=(self.w, self.h))
            clips.append(segment)
        
        final_video = concatenate_videoclips(clips, method="compose")
        
        if audio_file and Path(audio_file).exists():
            audio = AudioFileClip(audio_file)
            if audio.duration < final_video.duration:
                n_loops = int(final_video.duration / audio.duration) + 1
                audio = audio.loop(n=n_loops)
            final_video = final_video.set_audio(audio.subclip(0, final_video.duration))
        
        final_video.write_videofile(output_path, fps=CONFIG['fps'], codec='libx264',
                                   audio_codec='aac', bitrate=CONFIG['bitrate'],
                                   threads=8, preset='medium', logger=None)
        return output_path

class Generator:
    CONTENTS = {
        '1': ('Al-Fatiha', ["Bismillahir Rahmanir Rahim", "Alhamdu lillahi Rabbil 'alamin",
               "Ar-Rahmanir Rahim", "Maliki Yawmid Din", "Iyyaka na'budu wa Iyyaka nasta'in",
               "Ihdinas Siratal Mustaqim", "Siratal Ladhina An'amta 'Alayhim",
               "Ghayril Maghdubi 'Alayhim Walad Dallin"]),
        '2': ('Al-Ikhlas', ["Bismillahir Rahmanir Rahim", "Qul Huwallahu Ahad",
               "Allahus Samad", "Lam Yalid Wa Lam Yulad", "Wa Lam Yakun Lahu Kufuwan Ahad"]),
        '3': ('Al-Falaq', ["Bismillahir Rahmanir Rahim", "Qul A'uzu Birabbil Falaq",
               "Min Sharri Ma Khalaq", "Wa Min Sharri Ghasiqin Idha Waqab",
               "Wa Min Sharri Naffathati Fil 'Uqad", "Wa Min Sharri Hasidin Idha Hasad"]),
    }
    
    def __init__(self):
        self.scraper = ImageScraper()
        self.voice = ArabicVoice()
        self.builder = VideoBuilder()
    
    def generate(self, choice='1'):
        name, verses = self.CONTENTS.get(choice, self.CONTENTS['1'])
        print(f"\nhd4kstudio - {name}\n{'='*50}")
        images = self.scraper.download("islamic mosque", count=len(verses))
        audio = self.voice.create(verses[0], f"{name.lower()}.mp3")
        timestamp = datetime.now().strftime("%Y%m%d_%H%M")
        output = f"output/{name}_4K_{timestamp}.mp4"
        self.builder.build(images, verses, audio, output)
        print(f"\nDone: {output}")
        return output

def main():
    print("hd4kstudio - 4K Islamic Video Generator")
    gen = Generator()
    print("\nAvailable:")
    for k, (name, _) in gen.CONTENTS.items():
        print(f"  {k}. {name}")
    choice = input("\nSelect (1-3): ").strip()
    gen.generate(choice if choice in gen.CONTENTS else '1')

if __name__ == "__main__":
    main()
