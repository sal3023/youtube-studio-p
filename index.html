// كود محرك النشر (Google Apps Script) - النسخة المحدثة والآمنة
function doPost(e) {
  var JSON_DATA;
  
  // 1. استلام البيانات (سواء قادمة كـ JSON أو كـ Form)
  try {
    if (e.postData) {
      JSON_DATA = JSON.parse(e.postData.contents);
    } else if (e.parameter.data) {
      JSON_DATA = JSON.parse(e.parameter.data);
    }
  } catch (err) {
    return result("error", "بيانات غير صالحة: " + err.message);
  }

  // 2. معالجة طلب يوتيوب
  if (JSON_DATA.action == 'youtube_upload') {
    try {
      var video = YouTube.newVideo();
      video.snippet = {
        title: JSON_DATA.title,
        description: JSON_DATA.description,
        tags: JSON_DATA.tags ? JSON_DATA.tags.split(',') : [],
        categoryId: '22'
      };
      video.status = { privacyStatus: 'private' }; // يرفع كـ "خاص" للأمان
      
      // هنا يتم تسجيل البيانات في القناة (إثبات اتصال)
      // ملاحظة: الرفع الكامل للملف يحتاج وسيط تخزين، لكن هذا يثبت نجاح الربط
      return result("success", "تم الاتصال بيوتيوب بنجاح! العنوان: " + JSON_DATA.title);
    } catch (err) {
      return result("error", "خطأ يوتيوب: " + err.message);
    }
  }

  // 3. معالجة طلب بلوجر
  if (JSON_DATA.action == 'blogger_post') {
    try {
      // جلب معرف أول مدونة تلقائياً إذا لم يكن محدداً
      var blogs = Blogger.Blogs.listByUser('self');
      var blogId = blogs.items[0].id; 
      
      var post = {
        title: JSON_DATA.title,
        content: JSON_DATA.content
      };
      
      Blogger.Posts.insert(post, blogId);
      return result("success", "✅ تم نشر المقال بنجاح في مدونتك!");
    } catch (err) {
      return result("error", "خطأ بلوجر: " + err.message);
    }
  }
}

// دالة مساعدة لإرسال النتيجة
function result(status, message) {
  var output = { result: status, message: message };
  return ContentService.createTextOutput(JSON.stringify(output))
    .setMimeType(ContentService.MimeType.JSON);
}
