// app.js - الإصدار المتكامل والمتوافق
require('dotenv').config();
const express = require('express');
const crypto = require('crypto');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const { OpenAI } = require('openai');
const { GoogleAuth } = require('google-auth-library');
const { TwitterApi } = require('twitter-api-v2');
const next = require('next');

// تهيئة التطبيق
const dev = process.env.NODE_ENV !== 'production';
const nextApp = next({ dev });
const handle = nextApp.getRequestHandler();
const app = express();

// إعدادات الأمان للتوافق مع AdMob/AdSense
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: [
        "'self'", 
        "'unsafe-inline'", 
        "https://pagead2.googlesyndication.com",
        "https://www.googletagmanager.com",
        "https://www.google-analytics.com"
      ],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https://www.google-analytics.com"],
      connectSrc: ["'self'"],
      frameSrc: ["https://googleads.g.doubleclick.net"],
      fontSrc: ["'self'", "data:"]
    }
  },
  referrerPolicy: { policy: 'strict-origin-when-cross-origin' }
}));

// معدل الطلبات للتوافق مع سياسات الإعلانات
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 دقيقة
  max: 100 // 100 طلب لكل IP
});
app.use(limiter);

// نظام التشفير الآمن
const encrypt = (text) => {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv('aes-256-cbc', Buffer.from(process.env.ENCRYPTION_KEY), iv);
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return `${iv.toString('hex')}:${encrypted}`;
};

const decrypt = (text) => {
  const [ivHex, encrypted] = text.split(':');
  const iv = Buffer.from(ivHex, 'hex');
  const decipher = crypto.createDecipheriv('aes-256-cbc', Buffer.from(process.env.ENCRYPTION_KEY), iv);
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
};

// تخزين المفاتيح المشفرة
let apiKeys = {
  openai: process.env.OPENAI_KEY ? encrypt(process.env.OPENAI_KEY) : null,
  google: process.env.GOOGLE_KEY ? encrypt(process.env.GOOGLE_KEY) : null,
  twitter: process.env.TWITTER_KEY ? encrypt(process.env.TWITTER_KEY) : null
};

// واجهات API الآمنة
app.post('/api/keys', express.json(), (req, res) => {
  try {
    apiKeys = {
      openai: encrypt(req.body.openai),
      google: encrypt(req.body.google),
      twitter: encrypt(req.body.twitter)
    };
    res.json({ success: true });
  } catch (error) {
    res.status(500).json({ error: 'فشل في تخزين المفاتيح' });
  }
});

app.post('/api/generate', express.json(), async (req, res) => {
  try {
    const openai = new OpenAI({ apiKey: decrypt(apiKeys.openai) });
    const content = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [
        { role: "system", content: "Generate advertiser-friendly content." },
        { role: "user", content: req.body.prompt }
      ],
      max_tokens: 1000
    });
    res.json({ content: content.choices[0].message.content });
  } catch (error) {
    res.status(500).json({ error: 'فشل في إنشاء المحتوى' });
  }
});

// تهيئة Next.js
nextApp.prepare().then(() => {
  app.all('*', (req, res) => handle(req, res));
  
  const PORT = process.env.PORT || 3000;
  app.listen(PORT, () => {
    console.log(`الخادم يعمل على http://localhost:${PORT}`);
  });
});

// صفحة HTML الأساسية مع متطلبات AdSense
const htmlTemplate = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام إدارة المحتوى</title>
  <meta name="description" content="منصة متكاملة لإدارة المحتوى مع دعم الإعلانات">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
    crossorigin="anonymous"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-XXXXXXXXXXXXXXXX",
      enable_page_level_ads: true
    });
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .ad-container { margin: 20px 0; text-align: center; }
    @media (max-width: 768px) {
      .container { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="root"></div>
    <div class="ad-container">
      <!-- نموذج إعلان AdSense -->
      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
        data-ad-slot="XXXXXXXXXX"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>
  </div>
</body>
</html>
`;

// ملف .env المطلوب
/*
ENCRYPTION_KEY=your_32_byte_encryption_key_here
OPENAI_KEY=your_openai_api_key
GOOGLE_KEY=your_google_api_key
TWITTER_KEY=your_twitter_bearer_token
NODE_ENV=production
PORT=3000
*/
